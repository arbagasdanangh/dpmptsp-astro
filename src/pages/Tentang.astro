---
import MainLayout from "../layouts/MainLayout.astro";

const BASE_URL = "https://parkir.dpmptsp-surabaya.my.id";

/* ================= FETCH MENU ================= */
const resMenu = await fetch(`${BASE_URL}/api/v1/about-me`);
const menuJson = await resMenu.json();
const menus = menuJson?.data || [];

/* ================= DEFAULT CATEGORY ================= */
const defaultCategory = menus?.[0]?.category || "sambutan";

/* ================= FETCH CONTENT ================= */
const resContent = await fetch(
  `${BASE_URL}/api/v1/about-me/${defaultCategory}`
);
const contentJson = await resContent.json();
const contents = contentJson?.data?.data || [];

/* ================= ICON MAP ================= */
const iconMap = {
  sambutan: "fa-microphone",
  "visi-misi": "fa-bullseye",
  budaya: "fa-hands-helping",
  struktur: "fa-sitemap",
  perwali: "fa-gavel",
  ikm: "fa-smile",
};
---

<MainLayout title="Tentang DPMPTSP">
<section class="py-20 bg-gray-50">
  <div class="container mx-auto px-4 grid grid-cols-1 lg:grid-cols-4 gap-8">

    <!-- SIDEBAR -->
    <aside class="bg-white rounded-xl shadow p-6">
      <h3 class="text-lg font-semibold mb-4">Informasi Organisasi</h3>

      <div class="space-y-2">
        {menus.map((item, i) => (
          <button
            class={`menu-btn w-full text-left px-4 py-3 rounded-lg transition ${
              i === 0 ? "bg-blue-600 text-white" : "bg-gray-100 hover:bg-blue-50"
            }`}
            data-category={item.category}
          >
            <i class={`fas ${iconMap[item.category] ?? "fa-info-circle"} mr-2`}></i>
            {item.title}
          </button>
        ))}
      </div>
    </aside>

    <!-- CONTENT -->
    <div class="lg:col-span-3">
      <div id="content-area" class="bg-white rounded-xl shadow p-8 space-y-6">

        {contents.length === 0 && (
          <p class="text-gray-500 text-center">Data tidak tersedia.</p>
        )}

        {contents.map((item) => (
          <>
            {item.category === "sambutan" ? (
              <!-- SAMBUTAN = TEKS -->
              <article>
                <h2 class="text-2xl font-bold mb-4">{item.title}</h2>
                <div class="prose max-w-none">
                  {item.content || "Konten sambutan belum tersedia."}
                </div>
              </article>
            ) : (
              <!-- SELAIN SAMBUTAN = GAMBAR -->
              <article>
                <h2 class="text-2xl font-bold mb-4">{item.title}</h2>

                {item.file ? (
                  <img
                    src={`${BASE_URL}/storage/${item.file}`}
                    alt={item.title}
                    class="rounded-xl shadow max-w-full"
                  />
                ) : (
                  <p class="text-gray-500">Gambar tidak tersedia.</p>
                )}
              </article>
            )}
          </>
        )}
      </div>
    </div>
  </div>
</section>
</MainLayout>

<script>
  const buttons = document.querySelectorAll(".menu-btn");
  const contentArea = document.getElementById("content-area");
  const BASE_URL = "https://parkir.dpmptsp-surabaya.my.id";

  buttons.forEach((btn) => {
    btn.addEventListener("click", async () => {
      buttons.forEach((b) =>
        b.classList.remove("bg-blue-600", "text-white")
      );
      btn.classList.add("bg-blue-600", "text-white");

      const category = btn.dataset.category;

      contentArea.innerHTML =
        '<p class="text-center text-gray-500">Memuat data...</p>';

      try {
        const res = await fetch(
          `${BASE_URL}/api/v1/about-me/${category}`
        );
        const json = await res.json();
        const data = json?.data?.data || [];

        if (!data.length) {
          contentArea.innerHTML =
            '<p class="text-center text-gray-500">Data tidak tersedia.</p>';
          return;
        }

        contentArea.innerHTML = data
          .map((item) => {
            if (item.category === "sambutan") {
              return `
                <article>
                  <h2 class="text-2xl font-bold mb-4">${item.title}</h2>
                  <div class="prose max-w-none">
                    ${item.content || "Konten sambutan belum tersedia."}
                  </div>
                </article>
              `;
            }

            return `
              <article>
                <h2 class="text-2xl font-bold mb-4">${item.title}</h2>
                ${
                  item.file
                    ? `<img src="${BASE_URL}/storage/${item.file}" class="rounded-xl shadow" />`
                    : `<p class="text-gray-500">Gambar tidak tersedia.</p>`
                }
              </article>
            `;
          })
          .join("");
      } catch (e) {
        contentArea.innerHTML =
          '<p class="text-center text-red-500">Gagal memuat data.</p>';
      }
    });
  });
</script>
