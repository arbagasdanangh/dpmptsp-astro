---
import MainLayout from "../../layouts/MainLayout.astro";

/* ================= CONFIG ================= */
const BASE_URL = import.meta.env.PUBLIC_BASE_URL;

/* ================= FETCH API ================= */
const [ikmRes, categoryRes] = await Promise.all([
  fetch(`${BASE_URL}/api/v1/about-me/ikm`),
  fetch(`${BASE_URL}/api/v1/about-me`)
]);

if (!ikmRes.ok || !categoryRes.ok) {
  throw new Error("Gagal mengambil data IKM");
}

const ikmData = await ikmRes.json();
const categoryData = await categoryRes.json();

/* ================= DATA ================= */
// API 1 biasanya array
const ikm = Array.isArray(ikmData) ? ikmData[0] : ikmData;

// Judul kategori dari API 2
const categoryTitle =
  categoryData?.data?.ikm || "Indeks Kepuasan Masyarakat";
---

<MainLayout title={categoryTitle}>
  <main class="min-h-screen bg-gray-50">

    <!-- HEADER -->
    <section class="bg-blue-800 text-white py-16">
      <div class="container mx-auto px-4 text-center">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">
          {ikm?.title || categoryTitle}
        </h1>
        <p class="max-w-2xl mx-auto text-blue-100">
          {ikm?.description || "Informasi Indeks Kepuasan Masyarakat Organisasi"}
        </p>
      </div>
    </section>

    <!-- CONTENT -->
    <section class="container mx-auto px-4 py-16">
      <div class="bg-white rounded-2xl shadow-xl p-6 md:p-10 max-w-5xl mx-auto">

        <!-- IMAGE -->
        {ikm?.file && (
          <div class="mb-8">
            <img
              src={`${BASE_URL}/storage/${ikm.file}`}
              alt={ikm.title}
              class="w-full rounded-xl shadow-md"
              loading="lazy"
            />
          </div>
        )}

        <!-- META -->
        <div class="flex flex-wrap gap-6 text-sm text-gray-500 mb-8">
          <span class="flex items-center gap-2">
            ðŸ“‚ <strong>Kategori:</strong> {ikm?.category}
          </span>
          <span class="flex items-center gap-2">
            ðŸ—“ <strong>Tanggal:</strong>
            {ikm?.created_at &&
              new Date(ikm.created_at).toLocaleDateString("id-ID")}
          </span>
        </div>

        <!-- CONTENT -->
        <article class="prose max-w-none prose-blue">
          {ikm?.content ? (
            <div set:html={ikm.content} />
          ) : (
            <p>
              Dokumen <strong>Indeks Kepuasan Masyarakat (IKM)</strong> ini
              merupakan indikator resmi untuk mengukur kualitas pelayanan
              organisasi kepada masyarakat.
            </p>
          )}
        </article>

      </div>
    </section>

  </main>
</MainLayout>
