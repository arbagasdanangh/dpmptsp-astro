---
import MainLayout from "../layouts/MainLayout.astro";

/* ================= CONFIG ================= */
const BASE_URL = "https://parkir.dpmptsp-surabaya.my.id";

/* ================= FETCH MENU ================= */
let menus = [];

try {
  const res = await fetch(`${BASE_URL}/api/v1/about-me`);
  const json = await res.json();
  menus = Array.isArray(json?.data) ? json.data : [];
} catch (e) {
  console.error("Gagal load menu:", e);
}
---

<MainLayout title="Tentang DPMPTSP Surabaya">
  <section class="py-20 bg-gradient-to-b from-gray-50 to-white">
    <div class="container mx-auto px-4 grid grid-cols-1 lg:grid-cols-4 gap-10">

      <!-- SIDEBAR -->
      <aside class="lg:col-span-1">
        <div class="bg-white rounded-2xl shadow p-6 sticky top-24">
          <h3 class="text-lg font-bold text-blue-800 mb-4">
            Informasi Organisasi
          </h3>

          <div class="space-y-2">
            {menus.map((item, i) => (
              <button
                class={`tab-btn w-full text-left px-4 py-3 rounded-lg font-medium transition
                ${i === 0
                  ? "bg-blue-600 text-white"
                  : "bg-gray-100 hover:bg-blue-50 text-gray-700"}`}
                data-category={item.category}
              >
                {item.title}
              </button>
            ))}
          </div>
        </div>
      </aside>

      <!-- CONTENT -->
      <div class="lg:col-span-3">
        <div
          id="content-area"
          class="bg-white rounded-2xl shadow p-8 min-h-[420px]"
        >
          <p class="text-gray-500 text-center">
            Memuat data...
          </p>
        </div>
      </div>

    </div>
  </section>
</MainLayout>

<!-- ================= CLIENT SCRIPT ================= -->
<script>
const BASE_URL = "https://parkir.dpmptsp-surabaya.my.id";
const tabs = document.querySelectorAll(".tab-btn");
const contentArea = document.getElementById("content-area");

async function loadCategory(category) {
  contentArea.innerHTML = `
    <p class="text-gray-500 text-center">Memuat data...</p>
  `;

  try {
    const res = await fetch(`${BASE_URL}/api/v1/about-me/${category}`);
    const json = await res.json();

    // API: { data: { category, data: [] } }
    const list = json?.data?.data || [];

    if (!Array.isArray(list) || list.length === 0) {
      contentArea.innerHTML = `
        <div class="text-center text-gray-500">
          Informasi belum tersedia.
        </div>
      `;
      return;
    }

    contentArea.innerHTML = list.map(item => `
      <article class="mb-14 last:mb-0">

        <h2 class="text-3xl font-bold text-blue-800 mb-6">
          ${item.title}
        </h2>

        ${
          /* ‚ùå SAMBUTAN TIDAK BOLEH ADA GAMBAR */
          category !== "sambutan" && item.file
            ? `<img
                src="${BASE_URL}/storage/${item.file}"
                alt="${item.title}"
                class="rounded-xl shadow max-w-md mx-auto mb-8"
              />`
            : ""
        }

        ${
          (() => {
            /* üü¢ SAMBUTAN KOSONG ‚Üí TEKS RESMI & HALUS */
            if (category === "sambutan" && (!item.content || item.content.trim() === "")) {
              return `
                <div class="bg-blue-50 border border-blue-100 rounded-xl p-6">
                  <p class="text-gray-700 leading-relaxed">
                    Selamat datang di website resmi
                    <strong>Dinas Penanaman Modal dan Pelayanan Terpadu Satu Pintu
                    Kota Surabaya</strong>.
                  </p>

                  <p class="text-gray-700 leading-relaxed mt-4">
                    Kami berkomitmen untuk memberikan pelayanan perizinan dan
                    nonperizinan yang <strong>mudah, cepat, transparan,
                    dan profesional</strong> kepada masyarakat dan pelaku usaha.
                  </p>

                  <p class="text-gray-700 leading-relaxed mt-4">
                    Website ini merupakan sarana informasi resmi yang memuat
                    kebijakan, layanan, serta kinerja DPMPTSP Kota Surabaya.
                  </p>
                </div>
              `;
            }

            /* üü¢ CONTENT NORMAL */
            if (item.content && item.content.trim() !== "") {
              return `
                <div class="prose max-w-none text-gray-700">
                  ${item.content}
                </div>
              `;
            }

            /* üü° DEFAULT HALUS */
            return `
              <p class="text-gray-500 italic">
                Informasi sedang dalam proses pemutakhiran.
              </p>
            `;
          })()
        }

        <p class="text-sm text-gray-400 mt-6">
          Dipublikasikan:
          ${new Date(item.created_at).toLocaleDateString("id-ID")}
        </p>

      </article>
    `).join("");

  } catch (err) {
    console.error(err);
    contentArea.innerHTML = `
      <p class="text-red-500 text-center">
        Gagal memuat data.
      </p>
    `;
  }
}

// TAB CLICK
tabs.forEach((btn, index) => {
  btn.addEventListener("click", () => {
    tabs.forEach(b =>
      b.classList.remove("bg-blue-600", "text-white")
    );
    btn.classList.add("bg-blue-600", "text-white");

    loadCategory(btn.dataset.category);
  });

  // AUTO LOAD TAB PERTAMA
  if (index === 0) {
    loadCategory(btn.dataset.category);
  }
});
</script>
